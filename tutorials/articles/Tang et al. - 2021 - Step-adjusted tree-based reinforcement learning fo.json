{
    "article_id": "038b06a7-9127-428a-843b-c08ebe416e9d",
    "extracted_text": "Received:27May2020 Revised:31July2021 Accepted:9August2021\nDOI:10.1002/sim.9177\nRESEARCH ARTICLE\nStep-adjusted tree-based reinforcement learning for\nevaluating nested dynamic treatment regimes using\ntest-and-treat observational data\nMingTang1 LuWang1 MichaelA.Gorin2 JeremyM.G.Taylor1\n1DepartmentofBiostatistics,Universityof\nDynamic treatment regimes (DTRs) include a sequence of treatment decision\nMichigan,AnnArbor,Michigan\n2TheJamesBuchananBradyUrological rules, in which treatment is adapted over time in response to the changes in\nInstituteandDepartmentofUrology, anindividual\u2019sdiseaseprogressionandhealthcarehistory.Inmedicalpractice,\nJohnsHopkinsUniversitySchoolof\nnested test-and-treat strategies are common to improve cost-effectiveness. For\nMedicine,Baltimore,Maryland\nexample, for patients at risk of prostate cancer, only patients who have high\nCorrespondence prostate-specific antigen (PSA) need a biopsy, which is costly and invasive, to\nMingTang,DepartmentofBiostatistics,\nconfirmthediagnosisandhelpdeterminethetreatmentifneeded.Adecision\nUniversityofMichigan,AnnArbor,MI,\nUSA. about treatment happens after the biopsy, and is thus nested within the deci-\nEmail:mingtang@umich.edu sionofwhethertodothetest.However,currentexistingstatisticalmethodsare\nnotabletoaccommodatesuchanaturallyembeddedpropertyofthetreatment\nFundinginformation\nNationalInstitutesofHealth, decisionwithinthetestdecision.Therefore,wedevelopedanewstatisticallearn-\nGrant/AwardNumbers:CA129102,\ningmethod,step-adjustedtree-basedreinforcementlearning,toevaluateDTRs\nCA199338\nwithin such a nested multistage dynamic decision framework using observa-\ntionaldata.Ateachstepwithineachstage,wecombinedtherobustsemipara-\nmetricestimationviaaugmentedinverseprobabilityweightingwithatree-based\nreinforcement learning method to deal with the counterfactual optimization.\nThesimulationstudiesdemonstratedrobustperformanceoftheproposedmeth-\nods under different scenarios. We further applied our method to evaluate the\nnecessityofprostatebiopsyandidentifytheoptimaltest-and-treatregimesfor\nprostatecancerpatientsusingdatafromtheJohnsHopkinsUniversityprostate\ncanceractivesurveillancedataset.\nKEYWORDS\ndynamictreatmentregimes,multistagedecision-making,observationaldata,personalizedhealth\ncare,test-and-treatstrategy,tree-basedreinforcementlearning\n1 INTRODUCTION\nDynamictreatmentregimes(DTRs)have gainedincreasinginterestinthefieldofprecisionmedicineinthelastdecade.1\nThis research direction generalizes the individualized medical decisions into a time-varying treatment setting, usually\natdiscretestages,andthusaccommodatestheupdatedinformationforeachpersonateachstage.2,3 InDTR,actionsor\ndecisionsbasedontheindividualizedfeaturesareabletoleadtomoreprecisediseasepreventionandbetterdiseaseman-\nagement.However,thecurrentDTRframeworkislimitedwhentheactionofonetreatmentisnestedwithintheaction\n6164 \u00a92021JohnWiley&SonsLtd. wileyonlinelibrary.com/journal/sim StatisticsinMedicine.2021;40:6164\u20136177.TANGetal. 6165\nofanother.Amoreintuitiveexamplethatexplainsthelimitationinpracticeisatest-and-treatscenario:thetreatment\nactiononlyhappensafterthehappeningofadiagnostictestaction,whichmeansthatthetreatmentactioncannothap-\npenwhenthediagnostictestresultisnotavailable.Inparticular,inmedicalpractice,theprocedurestodiagnoseandtreat\npatientsaremuchmorecomplicated.Mostdiagnosisproceduresortests,forexample,positronemissiontomography,or\nabiopsytest,occurpriortotheselectionoftreatmenttoprovidemoreinformationaboutdiseasestatus,thenthisinfor-\nmationwouldbeusedtoselecttreatment.Typically,onlypatientswhohavetakenthetestcanbetreated,andthusthe\ndecisionaboutthetreatmentassignmentisnestedwithinthedecisionofperformingthetest.\nForexample,menwithearlystageasymptomaticprostatecancerwhoareinanactivesurveillanceprogram,would\nregularlyhavetheirprostate-specificantigen(PSA)andprostatetissuemeasuredviaabloodtestandcoreneedlebiopsy\ntest,respectively.4Whethertoundergodefinitivetreatmentfortheirprostatecancerwouldbestronglyinfluencedbythe\nresultsfromtheirbiopsytest.Sothepossibletreatmentinitiationonlyhappensafterhavingthebiopsytestresult,andis\nthusnestedwithinthedecisionofdoingabiopsyornot.Suchanesteddynamicclinicaldecision-makingisnotlimitedto\nprostatecancer.Theoccultbloodtest,alsoknownasastooltest,canalsobeusedasacheapandeasyinitialscreeningtest\nforcolorectalcancer.5Patientswithabnormalfindingfromthestooltestarethenreferredforacolonoscopyexam,which\niscostlyandinvasive,toconfirmthediagnosisanddecideifmoredefinitivetreatmentforcolorectalcancerisneeded.In\nthisscenariothedecisionofwhethertododefinitivetreatmentisnestedinthedecisionofwhethertodoacolonoscopy\nwhichisnestedwithinthedecisiontodoastooltestornot.Thiskindofnestedclinicaldecisionalsohappenswithmany\notherchronicdiseases.6\nInsuchnestedtest-and-treatscenarios,theimpactofthetestshouldalsobeconsidered.Forsomediseases,thetests\nusedtoconfirmthediagnosisordecideonthenextstepareeasytoadministerandminimallyinvasive,forexample,blood\ntestandphysicalexamination.Butsomeothertestsdoneforconfirmatorypurposesareexpensiveandinvasive,including\ntheprostatebiopsyandcolonoscopy.Thepotentialsideeffectsincludepain,soreness,andinfections,whichshouldnotbe\noverlooked.Forprostatecancer,evenifthetestresultsuggestsprogressivedisease,itisnotalwaysthecasethatthepatient\nshouldundergodefinitivetreatment,whichhassubstantialcomorbidity,sinceprostatecancerisaslowgrowingdisease\nandasubstantialnumberofmenmaynotdevelopdeadlyprostatecancerbeforedyingfromsomeothercause.Itiswell\nknownthatthereisovertreatmentforprostatecancer,andthatasubstantialnumberofmenreceiveunnecessarycancer\ntreatments.4 Therefore,carefulpatientselectionfortestingisneededtonotonlyreducetheimpactonthepatient,but\nalsotosavemedicalresourcesforthepatientswhotrulyneedthem.Thecurrentone-fits-allactivesurveillanceprotocol\nisnotcapableoftakingthepatient\u2019spersonalizedmedicalcharacteristicsintoaccountandthengivinganindividualized\ndiseasemanagementplan.\nAs mentioned above, most existing frameworks using the standard formulation for evaluating DTRs overlook or\nsimplify7-9 suchatest-and-treatnestedstructureduringtheclinicaldecision-makingprocess.Thediagnostictestitself\ndoesnothaveadirectimpactonthediseaserelatedoutcome,butthepotentialtreatmentfollowingthetestmayimprove\nthediseaseoutcomeforthepatientsubstantially.Ontheotherhand,thepatientwithoutadiagnostictestatallwillnot\nhavethehealthbenefitgainedfromthetreatmentstep.Insteadofsimplyunderstandingthetestandtreatastwosequential\nactions,wedistinguishthemtoemphasizetheirnestedrelationship.Overlookingsuchatest-and-treatnestedstructure\nmayresultinidentifyingimpreciseandnonrealisticdecisionrulesespeciallybyapplyingbackwardinduction.Although\ntheinformationofprevioustestandtreathistorymayhavebeenadequatelycaptured,whenthegeneralformulationis\nappliedinthetreatmentstep,patientswhodidnothavethetestarealsoincludedintothedecision-makingofthetreat-\nmentsteps.Themethodthatappliesthestandardformulationcouldinevitablyprovideanoptimaltreatmentstrategyfor\napatientevenwithoutatest.Sucharesultingtreatmentstrategyisnotcompatiblewiththeirobserveddata.Therefore,\nweproposeanewnesteddynamictreatmentregime(nested-DTR)frameworkbyembeddingthetreatmentstepwithinthe\nteststepofeachinterventionstageasshowninFigure1.Thisproposedframeworkspecificallydemonstrateshowtomod-\nifythestandardmethodintheimplementationstepstoincorporatethenestedrelationships,implementtherestricted\noptimization,andguaranteetheestimationresultsarecompatiblewiththeneedsraisedfromthebiomedicalproblems\nthemselves.\nIn general, DTRs can be estimated from observational data, provided there is enough heterogeneity in the patient\nfeatures and their actions taken. Similarly the optimal DTR for this new nested-DTR framework can be learned from\nobservationaldataprovidedthereisenoughheterogeneityindataforboththedecisiontotestandthedecisiontotreat.\nIn addition to extensive work on value of information methods in operations engineering and computer science\nwithin the framework of health policy-making,10,11 a great number of statistical methods have been developed to esti-\nmatetheoptimalDTRsusingobservationaldata,suchasmarginalstructuralmodelestimatedwithinverseprobability\nweighting,12 the marginal mean model,13 and other likelihood-based methods.14 These methods require a parametric6166 TANGetal.\nFIGURE 1 Hypotheticalstep-adjustedDTRwithatreatmentstepnestedwithintheteststepofeachinterventionstage.Thedecision\noftheteststepismadebasedonthehealthhistoryandthetreatmentdecisionismadeonthebasisofprevioushealthhistoryandtheupdated\nhistoryafterthetest\norsemiparametricconditionalmodelforthecounterfactualoutcomeasacomponentandthusarevulnerabletomodel\nmis-specification,especiallywhenthedataarehighdimensionalortime-dependentinformationisaccumulated.More\nrecently,machinelearning-basedapproaches,asareplacementforparametricorsemiparametricmodels,havebecome\nincreasingly popular because of their flexibility in model assumptions and their robustness.8,15 When identifying the\noptimal DTRs with multiple stages, the problem resembles the reinforcement learning (RL) problem.16 Therefore, RL\nmethodsarecurrentlybroadlyappliedinevaluatingtheoptimalDTRs.Someofthiswork,whichinvolvingreinforcement\nlearning,hasfocusedondevelopingeasilyinterpretableDTRsforreal-worldpractice.17-19\nTothebestofourknowledge,however,noneoftheexistingmethodscanbeapplieddirectlytoestimatetheoptimal\nDTRs when each stage consists of a treatment step nested within a test step. In this article, we are trying to fill this\ngap and develop a new nonparametric statistical learning method for identifying the optimal DTR within the nested\ndynamicdecisionframework.Ateachstepwithineachstage,wecombinetherobustsemiparametricestimatorobtained\nusing augmented inverse probability weighting (AIPW) with a modified tree-based reinforcement learning method to\noptimizetheexpectedcounterfactualoutcome.TheincorporationoftheAIPWestimatorfacilitatestherobustnessofthe\nestimatedoptimaldynamictreatmentregimewhilethetree-basedreinforcementlearningmethodisabletoprovidean\ninterpretable optimal strategy. The remainder of this article is organized as follows: In Sections 2 and 3, we formalize\ntheproblemofidentifyingtheoptimalDTRwithinthenestedDTRframeworkinamultiple-stagemultiple-stepsetting\nfromobservationaldataanddevelopthenestedstep-adjustedtree-basedreinforcementlearningmethod(SAT-Learning).\nSection4presentsthedetailedimplementationofthisnewmethod.Numericalsimulationstudiesandanapplicationto\ntheJohnsHopkinsUniversity(JHU)prostatecanceractivesurveillancedataareprovidedinSections5and6.Weconclude\nwithabriefdiscussioninSection7.\n2 MULTIPLE-STAGE NESTED STEP-ADJUSTED DYNAMIC TREATMENT\nREGIMES\nTo address the nested decision problem above, we consider a nested multistage multistep decision framework with S\ndecisionstages.Inclinicalpractice,everyregularclinicvisit,whichmightinitiatesomeformoftreatment,canbecon-\nsideredasastage.Withineachstages,thereareJ actionsteps.LetK denotethenumberofdecisionoptionsatstepj\nsj\nofstages(K \u22652),letD denotethemultipletreatmentindicatorsoftheactiontakenatstepjofstagesintheobserved\nsj sj\ndata,andthevalueofD isd \u2208\ue230 .Withoutlossofgenerality,weconsidertwostepswithineachstage,thatis,J =2,\nsj sj sj\ntomakethepresentationeasier.Weassumethefirststepofstagesistheteststep(actionD )andD inthetreatment\ns1 s2\nstep is nested within the decision of D . For example, only the prostate cancer patients who have had the biopsy test\ns1\nare considered for further treatment. We denote the patient\u2019s history prior to action D but after the previous step as\nsj\nX .Wewilluseoverbarwithsubscriptssandjtodenoteavectorofavariables\u2019shistoryuptothestepjofstages.For\nsj\nexample,X =(X ,X ,X , \u2026 ,X ,X ).Similarly,theactionhistoryuptothetreatmentstepofstagescanbedenoted\ns2 11 12 21 s1 s2\nasD =(D ,D ,D , \u2026 ,D ).\ns2 11 12 21 s1\nWeuseY todenotetheintermediaterewardoutcomeattheendofstepjofthestages,andthustheoverallrewards\nsj\nvector is (Y ,Y , \u2026 Y ) . The outcome of interest Y is a function of all rewards, that is, Y =f(Y ,Y ,Y , \u2026 Y ),\n11 12 S2 11 12 21 S2\nwheref(\u22c5)isaprespecifiedfunction(eg,sum).WealsoassumethatYisboundedandhighvaluesofYaredesirable.TheTANGetal. 6167\nobserveddatabeforestagesstepj(1\u2264s\u2264S,1\u2264j\u22642)are\n{X 11,D 11,Y 11,X 12, \u2026 ,D s\u22121,2,Y s\u22121,2,X s1}n \u2261{X s1,D s\u22121,2,Y s\u22121,2}n\ni=1 i=1\nforstep1,and\n{X ,D ,Y ,X , \u2026 ,X ,D ,Y ,X }n \u2261{X ,D ,Y }n\n11 11 11 12 s1 s1 s1 s2 i=1 s2 s1 s1 i=1\nfor step 2. For brevity, we suppress the subject index i in the following text when no confusion exists. The observed\ndata are assumed to be independent and identically distributed for n subject from the population of interest. The his-\ntory H is defined as the test results and action history prior to the action assignment D . To be more specific, H =\nsj sj s1\n(D s\u22121,2,X s1,Y s\u22121,2)andH =(D s1,X s2,Y s1).Toillustratethemethod,wealsospecifytwoactionoptionsintheteststep\ns2\nandthreeoptionsinthetreatmentstepofeverystage,thatis,d \u2208\ue230 ={0,1},K =2,andd \u2208\ue230 ={0,1,2},K =3.\ns1 s1 s1 s2 s2 s2\nWhenapatienthasd =0,thatis,notreatmentortestisgiven,theywillstillbekeptinthestudycohortbutnotgiven\nsj\nfurthertreatmentuntilthenextstages+1.Thus,therewardisY =0whend =0.Aslightmodificationofthisoccurs\nsj sj\ninourillustrativeexampleusingtheJHUActiveSurveillance(AS)dataset.InAS,ifapatientreceivestreatmentinsome\ntreatmentstep,thatis,d =1or2,theynolongerneedsfurthertestsortreatments,thuswouldberemovedfromthe\ns2\nstudy from that time onwards. However, as long as their reward Y is available, their data from already observed steps\nwouldstillbeusedintheestimationmethodbyspecifyingd =0andd =0,wheres\u2032 >s.\ns\u20321 s\u20322\nWith a treatment step nested after every test step within a stage, the nested DTR is defined as a personalized\ntest-and-treatmentrulesequence.TheruleisbasedontheobservedhistoryH aboutthepatient\u2019shealthstatusuptothe\nsj\nactioninstepjofstages.LetgdenotetheabovenestedDTR.Formally,g=(g ,g , \u2026 ,g )isdefinedbyacollectionof\n11 12 S2\nmappingfunctions,whereg ismappedfromthedomainofhistoryH tothedomainofD ,thatis,\nsj sj sj\nH \ue0b6\u2192g (H )\u2208\ue230 , 1\u2264s<S, 1\u2264j\u22642.\nsj sj sj sj\n3 STEP-ADJUSTED OPTIMIZATION FOR NESTED DTR\nLetY\u2217(g)bethecounterfactualoutcomeifallpatientsfollowgtoassigntreatmentortestconditionalonprevioushistory.\nTheperformanceofgismeasuredbythecounterfactualmeanoutcomeE{Y\u2217(g)}conditionalonthepatients\u2019history.We\ndenotetheoptimalregimeasgopt.Ourgoalofidentifyingtheoptimalregimeistofindthegoptwhichsatisfies\nE{Y\u2217(gopt)}\u2265E{Y\u2217(g)}\nforallg\u2208\ue233,where\ue233isthesetofallpotentialregimes.\n3.1 Optimizationofg andg forthelaststageS\nS2 S1\nThe approach to finding optimal DTR includes backward induction,13 therefore we illustrate the mathematical for-\nmulation from the last stage S. For the last step of the stage, let Y\u2217(d ) be the counterfactual outcome if a patient\nS2 S2\nmakes treatment decision d conditional on previous history. We denote the optimal regime as gopt, which satisfies\n{ ( )} S2 S2\nE Y\u2217 gopt \u2265E{Y\u2217(g )}forallg \u2208\ue233 ,where\ue233 isthesetofallpotentialregimesatstageSandstep2.\nS2 S2 S2 S2 S2 S2 S2 { }\nToconnectthecounterfactualoutcomewithobserveddata X ,D ,Y ,wemakethefollowingstandardcasual\nS2 S2 S2\ninferenceassumptions:2\n1. Consistency.Theobservedoutcomecoincideswiththecounterfactualoutcomeunderthetreatmentapatientisactually\ngiven,thatis,\n\u2211\nY = Y\u2217(d )I{g (H )=d }I{d =1},\nS2 S2 S2 S2 S2 S2 S1\nd \u2208\ue230\nS2 S26168 TANGetal.\nwhereI(\u22c5)istheindicatorfunctionthattakesthevalue1if\u22c5istrueand0otherwise.TheindicatorfunctionI(d =1)\nS1\nimpliesonlythesubjectswhodecidedtotaketheprevioustest,thatis,d =1,canhavetheirY observed.\nS1 S2\n2. Nounmeasuredconfounding.TheobservedactionD isindependentofpotentialcounterfactualoutcomesconditional\nS2\nonthehistoryH ,thatis,\nS2\nD \u27c2{Y\u2217(0),Y\u2217(1),Y\u2217(2)}|H ,\nS2 S2 S2 S2 S2\nwhere\u27c2denotesstatisticalindependence.Thisassumptionimpliesthatthepotentialconfoundersarefullyobserved\nandincludedinthedataset.\n3. Positivity.Fortheobservationaldata,thepropensityscore\ud835\udf0b (H ),theprobabilityofreceivingacertaintreatment\nd S2\nS2\nconditionalonhistory,isboundedawayfrom0and1,thatis,\ud835\udf0b (H )=Pr(D =d |H )\u2208[c ,c ],where0<c <\nd S2 S2 S2 S2 1 2 1\nS2\nc <1.\n2\nForthesubjectswhodonothavethetestinthepreviousstep,thatis,d =0,theirtestresultthatthefurthertreatment\nS1\ndecisionisbasedoncannotbeobserved.Therefore,onlythesubjectswithd =1isabletocontributetotheoptimization\nS1\nofg .Underthethreeassumptions,theoptimizationproblemforthetreatmentofthelaststagebecomes\nS2\n(\n\u2211\ngopt(H )=arg max E E(Y |D =d ,H )\nS2 S2 g \u2208\ue233 H S2 S2 S2 S2 S2\nS2 S2 d S2\u2208\ue230 S2 )\n\u00d7I[g (H )=d ]I(d =1) , (1)\nS2 S2 S2 S1\nwhere E (.) denotes the expectation with respect to the marginal joint distribution of the observed history H .\nH S2\nS2\nTo derive the optimal gopt for whether to take the test, that is, one step before the treatment step within the same\nS1\nstage S, we utilize the backwards induction.2 In addition to the counterfactual outcome of stage s step j Y\u2217 defined\nsj\n\u0303\u2217\nin the last section, we also define a nested step-adjusted future optimized counterfactual outcome Y . More specif-\nS1\nically, we have Y\u0303\u2217 ={Y\u2217(D S\u22121,2,g S1,g Sop 2t)}, where the treatment for stage S step 2 has been optimized. To determine\nS1\nthe optimal gopt, we propose to maximize the expected nested step-adjusted future optimized counterfactual outcome\nS1\n{Y\u0303 Y\u0303\u2217 S1 \u2217, (t 0h )a ,t Y\u0303i \u2217s, (1g )So }p 1t |H=a ,rg ifm dax g S =1\u2208\ue233 1S ,1E aH nS d1[ D{Y\u2217( \u27c2D S {\u2212 Y1, \u22172, (g 0S )1 ,, Yg \u2217Sop 2 (t 1)} )}]. |HSim ,il ia frl dy, w =e 0a ;ss pu om site ivn ito yu \ud835\udf0bnm (e Hasur )e =d Pco rn (Dfoun =di dng, |HD S1 )\u27c2\n\u2208\nS1 S1 s1 S1 S1 S1 S1 s1 S1 d S1 S1 S1 S1 sj\n[c ,c ], where 0<c <c <1;andthentheoptimizationproblemofstageSstep1canbewrittenas\n1 2 1 2\n[\n\u2211 {\ngopt =arg max E E[Y\u0303\u2217 |D =d ,H ]I(d =1)\nS1 g \u2208\ue233 H S1 S1 S1 S1 S1 S1\nS1 S1 d S1\u2208\ue230 S1 ]\n}\n+E[Y\u2217|D =d ,H ]I(d =0) I{g (H )=d } . (2)\nS1 S1 S1 S1 S1 S1 S1 S1\nDifferentfrom(1),theoptimizationprocess(2)ofgoptisconductedwithinalleligiblesubjects,whiletheoptimization\nS1\nofgoptisconductedonlywithinthepatientswhohavethetestatthepreviousstep.Althoughthewholecohortcontributes\ntothS2 eoptimizationstepin(2),Y\u0303\u2217 orY\u2217 usedin(2)actuallydependsonthetestdecision,thatis,d .Thesubjectswho\nS1 S1 S1\nhadthetest,thatis,d =1,essentiallyhaveonemorechancetooptimizetheirrewardsthroughstageSstep2compared\nS1\nwiththosewithouttest,andthischanceisnestedwithinthepositiveexamdecisionwithinthesamestage.\n3.2 Optimizationofg andg foranypreviousstagebeforeS\ns2 s1\nForthestepsofstagesbeforethelaststage(1\u2264s<S),theoptimalregimegoptandgoptisexpressedviabackwardinduc-\n\u0303\u2217 S1 S2\ntion as well. Y is defined as the nested step-adjusted future optimized counterfactual reward, which is given that all\nsj\nfuturestages\u2019andsteps\u2019actionsarealreadyoptimized.Morespecifically,wehaveY\u0303\u2217 s1(g s1)={Y\u2217(D s\u22121,2,g s1,g so 2pt, \u2026 ,g Sop 2t)}\nand Y\u0303\u2217 (g )={Y\u2217(D ,g ,gopt , \u2026 ,gopt)}. Similar to the assumptions for the last stage, we assume no unmeasured\ns2 s2 s1 s2 s+1,1 S2TANGetal. 6169\nconfoundingandpositivity.Undertheseassumptions,theoptimizationproblemsatstagesstepjcanbewrittenas\n[ ]\n\u2211\ngopt =arg max E E[Y\u0303\u2217|D =d ,H ]I{g (H )=d } (3)\ns1 g \u2208\ue233 H s1 s1 s1 s1 s1 s1 s1 s1\ns1 s1 d \u2208\ue230\ns1 s1\nand\n[ ]\n\u2211\ngopt =arg max E E[Y\u0303\u2217|D =d ,H ]I{g (H )=d }I(d =1) . (4)\ns2 g \u2208\ue233 H s2 s2 s2 s2 s2 s2 s2 s2 s1\ns2 s2 d \u2208\ue230\ns2 s2\n4 STEP-ADJUSTED TREE-BASED REINFORCEMENT LEARNING AND ITS\nIMPLEMENTATIONS\nGiven the observational data with test-and-treat nested decision structure, we propose to solve (1), (2), (3), and (4)\nthrough the step-adjusted tree-based learning (SAT-Learning) method. In this method, the step-adjusted future opti-\nmized pseudo-outcome is iteratively inducted backwards. We further assume, for stages and steps before the last\nstep, that is, for any s<S, j=1 or 2, the effect of intermediate outcome reward Y will be cumulatively carried\nsj\nforward to the final outcome,20 and denote a nested step-adjusted future optimized pseudo-outcome of stage s step\nj as PO sj. Let \ud835\udf07\u0302 sj,d (H sj)=E\u0302 [PO sj|D sj =d sj,H sj] be the estimated mean pseudo-outcome of stage s step j. Because of\nsj\nthe cumulative property of the reward outcome and the nested connection between the test step and the treatment\n\u2211\nstep, for any s<S, j=1 or 2, PO can be expressed in a recursive form as PO =Y + S \ud835\udf07 (H )\u00d7I(d =\n\u2211 sj \u2211 s1 s1 r=s r2,g ro 2pt r2 r1\n1)+ S \ud835\udf07 (H ) and PO =Y + S [\ud835\udf07 (H )\u00d7I(d =1)+\ud835\udf07 (H )]. Obviously, when evaluating the\nr=s+1 r1,gopt r1 s2 s1 r=s+1 r2,gopt r2 r1 r1,gopt r1\npseudo-outcomr e1 inlaststage,wehavePO =Y for r2 thesecondstepandPOr1 =Y +\ud835\udf07 (H )\u00d7I(d =1)forthe\nS2 S2 S1 s1 S1,gopt S1 S1\nS1\nfirststep.\nToreducetheaccumulatedbiasfromtheconditionalmeanmodels,insteadofusingthemodel-basedvaluesunder\noptimalfuturetreatments\ud835\udf07\u0302 sj,d (H sj)=E\u0302 [PO sj|D sj =d sj,H sj]fromPO sj,weusetheactualobservedintermediateoutcomes\nsj\nplustheexpectedfutureloss(orgain)duetothesuboptimaltreatmentsasthemodifiedpseudo-outcomePO\u2032.20Specifi-\nsj\naca nl yly s,t <he S,m jo =di 1fi oe rd 2p ,seudo-outcomeofthelaststageisPO\u2032 S2 =Y S2,PO\u2032 S1 =Y S1+\ud835\udf07 S2,g Sop 2t(H S2)\u2212\ud835\udf07 S2,D S2(H S2)+Y S2andfor\n\u2211S [ ]\nPO\u2032 sj = \ud835\udf07 r1,g ro 1pt(H r1)\u2212\ud835\udf07 r1,D r1(H r1)+Y r1+I[d r1 =1][\ud835\udf07 r2,g ro 2pt(H r2)\u2212\ud835\udf07 r2,D r2(H r2)+Y r2]\nr=s+1 [ ]\n+Y sj+I[j=1]I[d sj =1] \ud835\udf07 s2,g so 2pt(H s2)\u2212\ud835\udf07 s2,D s2(H s2)+Y s2 . (5)\nInparticular,ifthesubjectundergoesthetestatstages,thatis,d =1,theymightbenefitfromthepotentialsubse-\ns1\nquenttreatmentwithinthatstageviatheoptimizationofthefuturetreatmentstep.Ifthesubjectdoesnotreceivethetest\natstages,thentheirfutureoptimizedcounterfactualoutcomecanonlybeoptimizedthroughtheoptimalactionsofthe\nfuturestages.\nWeproposetoimplementSAT-Learningthroughamodifiedversionofatree-basedreinforcementlearningmethod\n(T-RL),17whichemploystheclassificationandregressiontree(CART).21InthenestedDTRsetting,weneedtoincludethe\nstep-wiseadjustmenttoaccountforthenestedtest-and-treatnature.Thus,wedevelopedamodifiedtree-basedalgorithm\ntoimplementSAT-LearningforestimatingtheoptimalnestedDTR.Traditionally,thedecisiontreeofCARTisbuiltto\nchooseasplitthatwouldhavethepurestchildnodes.Thepurestnodemeanshavingthelowestmisclassificationrate\namongallpossiblenodes.Thus,purityisacrucialmeasuretogrowadecisiontree.DifferentfromCART,SAT-Learning\nat each node selects the split to improve the counterfactual mean reward, which can serve as a measure of purity in\nnested DTR trees, and then maximizes the population\u2019s counterfactual mean reward of interest. Similarly as in T-RL,\nto estimate the optimal DTR, we use a purity measure for SAT-Learning based on the augmented inverse probability\nweighting(AIPW)estimatorofthecounterfactualmeanoutcome.\nIntheprocessofpartitioningofthistree-basedreinforcementlearningmethod,foragivenpartition\ud835\udf14and\ud835\udf14cofnode\n\u03a9,letg sj,\ud835\udf14,d,d denotethedecisionrulethatassignsasingletest/treatmentactiond 1toallsubjectsin\ud835\udf14andtreatmentd 2\n1 26170 TANGetal.\ntosubjectsin\ud835\udf14catstagesstepj(1\u2264s\u2264S,j=1,2).Thenthepuritymeasurecanbedefinedas\n\u23a1\u2211K \u23a4\nsj\n\ue23c sj(\u03a9,\ud835\udf14)= 1m 2a \u2208x P n\u23a2 \u23a2 =1\ud835\udf07\u0302 sA j,I dP sW (H sj)I{g sj,\ud835\udf14,d 1,d 2(H sj)=d sj}I(H sj \u2208\u03a9)\u23a5 \u23a5 \u23a6, (6)\nd ,d \ue230 sj \u23a3d j\nsj\nwhereP istheempiricalexpectationoperatorandP {\ud835\udf07\u0302AIPW(H )}istheAIPWestimatorofthecounterfactualmean\nn n sj,d sj\nsj\noutcomewith\n{ }\nI(D =d ) I(D =d )\n\ud835\udf07\u0302 sA j,I dP sW (H sj)= sj,dsj sjsj Y sj+ 1\u2212 sj,dsj sjsj \ud835\udf07\u0302 sj,d sj(H sj). (7)\nj \ud835\udf0b\u0302 (H ) \ud835\udf0b\u0302 (H )\nsj sj\nIn(7),thepropensityscoremodelisdenotedas\ud835\udf0b sj,d (H sj)andtheconditionalmeanmodelisdenotedas\ud835\udf07 sj,d (H sj).\nsj sj\nUndertheforegoingthreecausalinferenceassumptions,P {\ud835\udf07\u0302AIPW(H )}isaconsistentestimatorofthecounterfactual\nn sj,d sj\nsj\nmean outcome E{Y\u2217(d sj)} if either the propensity score model \ud835\udf0b sj,d (H sj) or the conditional mean model \ud835\udf07 sj,d (H sj) is\nsj sj\ncorrectlyspecified.ThusthisAIPWestimatorisdoublyrobustforestimatingthecounterfactual meanoutcomeofthe\npopulation.18\nInournestedstep-adjustedmultistagesetting,forthelaststepofthelaststage,S2,wehaveY in(7)astheobserved\nS2\nrewardofthelaststepofthelaststage.Forotherstagesstepjbeforethelastone(1\u2264s<S,j=1,2ors=S,j=1),Y in\nsj\n\u0302\u2032\n(7)isreplacedwithPO ,thecorrespondingpseudo-outcomedefinedin(5).\nsj\nIntheprocessofmaximizing\ue23c (\u03a9,\ud835\udf14),thepossiblesplit\ud835\udf14ofagivennode\u03a9shouldbeeitherasubsetofacategorical\nsj\ncovariatecategoriesorvaluesthatarenotlargerthanthethreshold.Thebestcriteria\ud835\udf14\u0302opttosplitagivennodeisapartition\nthat is able to maximize the improvement in the purity, \ue23c (\u03a9,\ud835\udf14)\u2212\ue23c (\u03a9), where \ue23c (\u03a9) is for the situation where we\nsj sj sj\nassignthesamesingletest/treatmentactiontoallsubjectin\u03a9,thatis,nosplitting.Tocontroltheoverfittingandalso\nmakepracticalandmeaningfulsplits,apositiveintegern isspecifiedastheminimalnodesizeandapositiveconstant\ud835\udf06\n0\nisalsoprovidedasathresholdforthemeaningfulimprovement.Besidesthetwogivenconstantvalues\ud835\udf06andn ,weapply\n0\nsimilarstoppingrulesasinReference17togrowandsplitthetree.Ourstoppingrulescanbefoundinthesupplementary\nmaterialsasAlgorithm1.Thedepthofanodementionedinthestoppingrulesisdefinedasthenumberofedgesfrom\nthenodetothetree\u2019srootnode,andarootnodehasadepthof0.ThenestedSAT-Learningalgorithmgiventheabove\npurity measures and stopping rules of the partitioning is presented in Algorithm 2 with details. (Also provided in the\nsupplementarymaterials).Notetheessentialdifferencebetweenstepsj=2andj=1isthatdifferentsubjectsareincluded\nintothecalculationoftheAIPWestimator.Onlythesubjectswhohavetakenthetestatstages,thatis,d =1,contribute\ns1\ntotheoptimizationoftheirsubsequenttreatments.\nWhenimplementingSAT-Learningprocess,thepropensityscore\ud835\udf0b\u0302 sj,d (H sj)in(7)canbeestimatedbyamultinomial\nsj\nlogisticregressionmodel.ThisworkingmodelcouldincorporatelinearmaineffecttermsfromhistoryH andsummary\nsj\nvariablesorinteractiontermsbasedonpriorscientificknowledgefromindividualhistoryH .Forcontinuousoutcome,\nsj\ntheconditionalmeanestimates\ud835\udf07\u0302 sj,d (H sj)in(7)couldbeobtainedeitherfromalinearparametricregressionmodelor\nsj\nfromotheroff-the-shelfnonparametricmachinelearningmethods,suchasrandomforestsorsupportvectorregression,\ndepending on the history H and the test/treatment action D . For estimating the conditional mean model for binary\nsj sj\norothercountoutcomes,onecoulduseageneralizedlinearmodelsorothergeneralizedclassificationtoolsinmachine\nlearning.\n5 SIMULATION STUDIES\n5.1 Simulationstudiestoevaluatethegeneraltest-and-treatnestedDTR\nWegeneratesimulationstudydatathatmimicthereal-worldobservationaltest-and-treatstudy.Weassumeatwo-stage\ntwo-stepnesteddynamictreatmentregime,usingD withsubscriptvalues=1,2torepresentthestageandj=1,2torep-\nsj\nresentthetestandtreatmentactionwithineachstage.Morespecifically,wesettwooptionsintheteststepasd =1or0\ns1\ntoindicatereceivingthetestornot,andthreetreatmentoptionsinthetreatmentstepasd =0,1or2.Wefurtherdefine\ns2\ntheoutcomeofinterestasthesumofintermediaterewardsfromeachstageandstep,thatis,Y =Y +Y +Y +Y .\n11 12 21 22\nTheunderlyingoptimaltreatmentissupposedtohavethelargestexpectedreward.TheothertwosuboptimaltreatmentsTANGetal. 6171\nhavelowerexpectedrewards.Wefurtherconsidertwocases.Oneisthattheexpectedrewardfromthetwosuboptimal\ntreatmentsareequalwhileintheothercase,theexpectedrewardofthetwosuboptimaltreatmentsaredifferent.There-\nfore,inthesecondcase,thesuboptimalrewardlossesaredifferentbecausepatientsmaylosemoretreatmentbenefitdue\ntochoosingonesuboptimaltreatmentcomparedwithanother.\nWhentheteststepinitiatingeachinterventionstepisnotexpensiveorinvasive,morepatientstendtochoosesucha\ntestbecausetheymightbenefitfromknowingthetestresultforthelong-termdiseasecontrolpurpose.However,when\nthelabtestisunpleasantandcostly,suchasaprostatebiopsytest,thepatientswouldhesitatetotakeit.Therefore,when\ngenerating data we consider three scenarios based on the patients\u2019 willingness to receive the exam by modifying the\nparameterstosettheratioofhavingornothavingthetestas1:1,2:1,and1:2,whichcorrespondtotheequalpreference,\nmorelikely,andlesslikelytotaketheexam,respectively.Thispreferenceratio,insteadofreflectingthewillingnessof\nbeingtestedforeachindividual,ismorelikeafactorthatdescribesthenatureofthetest,suchasthecost,invasiveness\nandothersideeffects.Forthesethreescenarios,threecovariates,X toX ,generatedasthebaselinecovariatesfollow\n1 3\nN(0,1).Twocorrelatedcovariates,X andX 5,aregeneratedastime-varyingbiomarkerswhichare(measured)justbefore\n4\n1 0.1\nthedecisiontimeoftheteststepwithineachstage.(X 4,X 5)\u2032 \u223cN(\ud835\udf07,\u03a3),where\ud835\udf07 =(0,0)\u2032 and\u03a3= 0.1 1 .Afterthe\nteststepofeachstage,thecovariatesX andX mimicthetestresultsthatcontributetothetreatmentdecisionnested\n12 22\nwithin each test decision with other covariates. Typically, the test results, such as biopsy results, are of great impor-\ntancetothetreatmentdecision-making.X andX followthedistributionofN(0,1).Detailsofparametersettingareas\n12 22\nfollows:\nStage 1: The test decision variables, D 11 \u223cBernoulli(\ud835\udf0b 11,1) with \ud835\udf0b 11,1 =exp(0.6X 3\u22120.2X 2+X 4)\u2215(1+exp(0.6X 3\u2212\n0.2X +X )).Therewardofstep1ofstage1isgeneratedasY =X2+(0.5X +3)2\u00d7I[gopt(H )=D ]\u22123|X |\u00d7I(D =\n2 4 11 4 3 11 11 11 1 11\n1)+\ud835\udf16 withoptimalregimesdefinedas\n11\n\u23a7 I(X >\u22120.5)I(X \u22640.3) forScenario1\n\u23aa 1 4\ngopt(H )=\u23a8I(X >\u22120.8)I(X \u22641) forScenario2\n11 11 1 4\n\u23aa\n\u23a9I(X >0.3)I(X \u22641.3) forScenario3,\n1 4\nand \ud835\udf16 \u223cN(0,1). Scenarios 1, 2, and 3 correspond to patients\u2019 equal preference, more likely, and less likely to\n11\ntake the test, respectively. For patients who have taken the test, that is, D =1, we further generate the treatment\n11\nassignment D 12 for them as D 12 \u223cMultinomial(\ud835\udf0b 12,0,\ud835\udf0b 12,1,\ud835\udf0b 12,2) with \ud835\udf0b 12,0 =1\u2215(1+exp(0.5X 12\u22120.2X 2)+exp(0.2X 4+\n0.3X 3)), \ud835\udf0b 12,1 =exp(0.5X 12\u22120.2X 2)\u2215(1+exp(0.5X 12\u22120.2X 2)+exp(0.2X 4+0.3X 3)) and \ud835\udf0b 12,2 =exp(0.2X 4+0.3X 3)\u2215(1+\nexp(0.5X \u22120.2X )+exp(0.2X +0.3X )).Also,Y =I[D =gopt(H )](2X +3X )2+(X +X \u22172+X )+Y \u22153+\ud835\udf16\n12 2 4 3 12 12 12 12 12 2 1 3 4 11 12\nforequalsuboptimalrewardloss;and\nY =I[D =gopt(H )](2X +3X )2+(X +X \u22172+X )+Y \u22153\n12 12 12 12 12 2 1 3 4 11\n+0.5I(D =1)[I(gopt(H )=1)\u22121]+1.2I(D =2)[I(gopt(H )=2)\u22121]+\ud835\udf16\n12 12 12 12 12 12 12\nforunequalsuboptimalrewardlosswith\ud835\udf16 \u223cN(0,1).Thetree-typeoptimalregimeatstep2isspecifiedas\n12\n\u23a7 0 X >0.2\n\u23aa 12\ngopt(H )=\u23a81 X >\u22120.7,X \u22640.2\n12 12 \u23aa 1 12\n\u23a92 otherwise.\nStage 2: We generate the test decision of stage 2, D 21 \u223cBernoulli (\ud835\udf0b 21,1) with \ud835\udf0b 21,1 =exp(0.5X 1\u22120.6X 2+X 3)\u2215(1+\nexp(0.5X \u22120.6X +X )). The reward of stage 2 step 1 is generated as Y =X2+2X +(X +3.2)2I[gopt(H )=D ]\u2212\n1 2 3 21 5 1 3 21 21 21\n3I(D =1)+\ud835\udf16 with\ud835\udf16 \u223cN(0,1).Theoptimalregimegopt(H )isspecifiedas\n21 21 21 21 21\n\u23a7 I(X \u2264\u22120.3)+I(X >\u22120.3)I(X \u22651) forScenario1\n\u23aa 1 1 5\ngopt(H )=\u23a8I(X \u22640.4)+I(X >0.4)I(X \u22651.2) forScenario2\n21 21 \u23aa 1 1 5\n\u23a9I(X \u2264\u22120.8)+I(X >\u22120.8)I(X \u22651) forScenario3.\n1 1 56172 TANGetal.\nTABLE 1 Simulationresultsforthegeneraltest-and-treatcasefortheequalandunequalrewardlossforsuboptimaltreatment\noptions:twointerventionstages,threetreatmentoptionsateachstagenestedwithintheexamateachstagewith500replications,and\nn=1000or2000\nScenario Scenario Scenario\nSuboptimal 1(1:1) 2(2:1) 3(1:2)\nReward opt% opt% opt%\nn=1000 (a) 90.1(7.4) 86.1(9.2) 91.9(6.3)\nEqualloss (b) 84.7(7.5) 81.0(7.9) 86.9(6.4)\n(c) 90.1(7.6) 86.3(9.3) 92.1(6.4)\n(a) 96.2(3.8) 96.3(4.0) 97.7(2.0)\nUnequalloss (b) 92.0(6.1) 87.5(12.5) 94.7(4.1)\n(c) 96.0(4.1) 96.2(4.4) 97.6(2.2)\nn=2000 (a) 91.2(7.5) 86.8(9.3) 93.2(6.4)\nEqualloss (b) 85.8(6.6) 81.9(6.3) 88.2(6.1)\n(c) 91.1(7.5) 86.9(9.3) 93.2(6.4)\n(a) 96.9(3.4) 97.7(2.7) 98.2(1.8)\nUnequalloss (b) 96.6(3.6) 93.8(8.8) 97.7(1.7)\n(c) 96.9(3.4) 97.7(2.6) 98.1(1.8)\nNote:opt%showstheempiricalmeanandstandarddeviation(SD)ofthepercentageofsubjectscorrectlyclassifiedtotheirunderlyingtrueoptimal\ntreatments,estimatedbytheproposedmethodwhen(a)theconditionalmeanmodelandthepropensityscoremodelarebothcorrectlyspecified,(b)the\nconditionalmeanmodelismis-specifiedandthepropensityscoremodeliscorrectlyspecified,and(c)theconditionalmeanmodeliscorrectlyspecified\nandthepropensityscoremodelismis-specified.Scenarios1,2,and3correspondtothecaseswhenthetrueratiosofpreferenceforhavingtheexamvsnot\nhavingtheexamamongallpatientsare1:1,2:1,and1:2.\nAmong the patients who have had the test, that is, D =1 we generate their treatment assignment D for\n21 22\nthe second step of stage 2. Specifically, we generate treatment D 22 \u223cMultinomial(\ud835\udf0b 22,0,\ud835\udf0b 22,1,\ud835\udf0b 22,2) with \ud835\udf0b 22,0 =\n1\u2215(1+exp(0.35X 22\u2212X 5)+exp(0.3X 2+0.2X 3)), \ud835\udf0b 22,1 =exp(0.35X 22\u2212X 5)\u2215(1+exp(0.35X 22\u2212X 5)+exp(0.3X 2+0.2X 3)),\nand\ud835\udf0b 22,2 =exp(0.3X 2+0.2X 3)\u2215(1+exp(0.35X 22\u2212X 5)+exp(0.3X 2+0.2X 3)).Therewardofstage2step2isgeneratedas\nY =3I[D =gopt(H )]+Y +(2+X X +X )+\ud835\udf16 forequalsuboptimalrewardloss;and\n22 22 22 22 21 4 5 3 22\nY =(3+X )I[D =gopt(H )]+Y +(2+X X +X )\n22 22 22 22 22 21 4 5 3\n+2I(D =1)[I(gopt(H )=1)\u22121]+I(D =2)[I(gopt(H )=2)\u22121]+\ud835\udf16\n22 22 22 22 22 22 22\nforunequalsuboptimalrewardloss,and\ud835\udf16 \u223cN(0,1).Theoptimaltreatmentregimeforstage2gopt(H )isspecifiedas\n22 22 22\n\u23a7 0 X >0.5\n\u23aa 22\ngopt(H )=\u23a81 X \u22640.5,X <0.3\n22 22 \u23aa 22 5\n\u23a92 otherwise.\nTable1summarizesthesimulationstudyresultsacrossdifferentscenariosasdescribedabove.OurSAT-Learningmethod\nforestimatingtheoptimalDTRinvolvesadoublyrobustsemiparametricestimator,thereforeoursimulationsalsotryto\ndemonstrate such robustness. In addition to having one estimation scheme with the conditional mean model and the\npropensityscoremodelbothcorrectlyspecified,weconsidertwomoreschemeswitheitherthepropensityscoremodel\northeconditionalmeanmodelmis-specifiedbyomittingsomeofthecovariatesofthetrueform.Weconsiderasample\nsizeofeither1000or2000forthetrainingdataset,andasamplesizeof2000forthevalidation,andrepeatthesimulation\n500times.Thetrainingdatasetisusedtoestimatetheoptimalregimeandthenpredicttheoptimaltest-and-treatdecision\nin the validation dataset, where the underlying true optimal regimes are already known. The percentages of subjects\ncorrectlyclassifiedtotheoptimaltest-and-treatmentdecisioninbothstagescombinedisdenotedasopt%.Theaverage\nopt%andtheempiricalstandarddeviation(SD)amongtherepetitionsevaluatetheperformance.TANGetal. 6173\nTABLE 2 Simulationtomimicthemonitoringandmanagementofprostatecancer:twointervention\nstages,twotreatmentoptionsateachstagenestedwithintheexamateachstagewith500replications,and\nn=1000or2000.\n5% 15% 20% 25%\nTreatmentrate opt% opt% opt% opt%\nn=1000 (a) 92.8(4.9) 93.8(4.8) 94.9(4.5) 95.3(4.6)\n(b) 91.6(2.1) 93.2(1.9) 93.9(1.5) 94.3(1.4)\n(c) 91.8(5.6) 93.2(5.8) 94.0(5.9) 94.6(5.5)\nn=2000 (a) 93.7(4.7) 94.9(4.6) 95.7(4.4) 96.7(3.7)\n(b) 92.6(1.9) 94.0(1.4) 94.5(1.2) 94.7(1.1)\n(c) 92.2(6.5) 93.9(6.6) 94.6(6.5) 95.5(6.1)\nNote:opt%showtheempiricalmeanandstandarddeviation(SD)ofthepercentageofsubjectscorrectlyclassifiedtotheir\nunderlyingtrueoptimaltreatments,estimatedbytheproposedmethodwhen(a)theconditionalmeanmodelandthe\npropensityscoremodelarebothcorrectlyspecified,(b)theconditionalmeanmodelismis-specifiedandthepropensity\nscoremodeliscorrectlyspecified,and(c)theconditionalmeanmodeliscorrectlyspecifiedandthepropensityscoremodel\nismis-specified.Differenttreatmentratescorrespondtodifferentproportionsofpatientswhoswitchfromactive\nsurveillancetocurativetreatmentamongthosewhohavetakenthebiopsytest.\nInTable1,theresultsofequalsuboptimalrewardcasedemonstratethelossduetosuboptimalequallyinferiorcom-\nparedwiththeoptimalchoice.Inscenario1,wherethesubjectshaveanevenpreferenceofhavingtest,underthesample\nsizen=1000,90.1%ofthepatientsarecorrectlyassignedtotheiroptimalDTRsforbothstageswhenboththecondi-\ntionalmeanmodelandthepropensityscoremodelarecorrectlyspecified.Wheneithertheconditionalmeanmodelor\nthepropensityscoremodelismis-specified,butnotboth,theoverallperformancesareslightlyworse,butstillreasonably\nsatisfactory.Morespecifically,wheneitherthepropensityscoremodelortheconditionalmeanmodelisincorrectlyspec-\nified,westillget90.1%andhave84.7%respectively.SimilartrendsarefoundinScenarios2and3,andresultsimprove\nas sample size goes to n = 2000. However, when the reward loss is unequal among suboptimal treatment options, the\noptimal regimes stand out among the candidate treatments more obviously according to our data generating process;\ntherefore,itiseasierforourproposedmethodSAT-Learningtodistinguishtheoptimaltreatmentfromsuboptimalones.\nThus, the simulation performance with varying suboptimal loss is better than when the suboptimal loss is equal, as\nexpected.\n5.2 Aspecialcasewhenthetreatedpatientsnolongerneedfurthertestortreatment\nWe conduct another simulation study for a special case when the treated patients no longer need test and treatment\nagain.Thissimulationbettermimicsthemonitoringandmanagementinactivesurveillanceforprostatecancer.Because\nof the significant side-effects of curative intervention and the asymptomatic nature of prostate cancer, according to\nthe American Society of Clinical Oncology, patients with low-risk prostate cancer can consider active surveillance22\nActive surveillance involves monitoring prostate cancer by regular exam in its localized stage until further treatment\nis needed to halt the disease at a curable stage. More specifically, the patients who have taken the biopsy test, only\na small proportion of them would switch from the active surveillance to curative intervention. In the active surveil-\nlance, the patients who have been treated should be removed from the active surveillance cohort, because physicians\nconsider that they no longer need to be treated and additional treatment is not provided and they are not eligible for\nthe active surveillance. Therefore they should not be considered to evaluate the subsequent test or treatment deci-\nsion. We generate data under a two-stage nested DTR with two treatment options at each stage. We also modify the\nparameters in the data generating models to make the rates of taking the curative treatment equal to 5%, 15%, 20%,\nand 25% in both stage. The higher the rate is, the more patients take the treatment and thus more patients will be\nremovedfromthesurveillanceafterwards.Thedetailedinformationofdatagenerationcanbefoundinthesupplementary\nmaterials\nThesimulationresultsaresummarizedinTable2.Astheresultsshow,becauseofthenicedoublyrobustproperty,\nthepercentagesofsubjectscorrectlyclassifiedtotheirunderlyingtruthbothyieldsatisfyingresultsevenwheneitherthe6174 TANGetal.\npropensityscoremodelortheconditionalmeanmodelismis-specified,butnotboth.Consideringsamplesizen=1000\nasanexample,when5%oftestedpatientshavethecurativetreatmentandthenareremovedfromtheactivesurveillance,\n92.8%ofthemarecorrectlyassignedtotheiroptimalDTRforbothstageswhenboththeconditionalmeanmodeland\nthepropensityscoremodelarecorrectlyspecified.Wealsohave 91.8%and91.6%ofthepatientscorrectlyclassifiedto\ntheiroptimalDTRwhenthepropensityscoremodelortheconditionalmeanmodelismis-specifiedrespectively.Asthe\ntreatmentrateincreases,weareabletoestimatebetteroptimaltreatmentrulesfromlargerheterogeneoussampleswith\nmoreinformation.Therefore,itiseasierforourproposedSAT-Learningtoestimatetheoptimalregimefromthismore\ninformative sample. Thus, the simulation performance with a higher treatment rate is slightly better than that for the\nlowerratecase.\n6 APPLICATION TO PROSTATE CANCER ACTIVE SURVEILLANCE DATA\nWe illustrate SAT-Learning using the prostate cancer Active Surveillance dataset from Johns Hopkins University.22 In\nthisactivesurveillancestudy,enrollmentofmenwithlow-riskprostatecancerstartedin1995andendedin2015.Eligible\nsubjects need to have PSA density less than 0.15 \u03bcg/L per mL, clinical stage T1c disease or lower, the Gleason score\nbetween2and6,atmosttwopositivebiopsycores,andatmost50%tumorinanysinglecore,allofwhichmadethem\nlow risk. The Johns Hopkinsactive surveillance protocol includessemiannual PSAand annual prostate biopsy.In the\nprotocol, the primary reason that patients would be recommended to undergo definitive curative radiation therapy or\nsurgeryisifthebiopsyresultshowedanadversechangecomparedwithpreviousbiopsies.\nThereissufficientevidencethattheapproachofactivesurveillance,thatis,delayingcurativetreatment,forlow-risk\npatientsissafe.23Theissuewewillbeconsideringishowitshouldbeimplemented.Thatis,ratherthanhavinganannual\nbiopsy,asintheprotocol,shoulditbemoreindividualized,withthedecisionofwhethertoundergoabiopsybasedon\ntheavailabledataatthattimeforthatpatient.\nNot all the patients in the study followed the protocol. In the dataset we analyzed, 22% of patients did not have\nthe scheduled biopsy of the first year and 5% of them did not have the biopsy in the first 2 years. Similarly for cura-\ntive therapy, quite a number of patients did not follow the protocol.22 Such heterogeneity in the observed data allows\nustoapplythenestedDTRmethodviaourproposedSAT-Learningtodecideateachstagewhetherthepatientshould\nhave the biopsy, and if so, whether the treatment should be recommended based on the patients\u2019 individualized char-\nacteristics. In the analysis presented below we restrict the observational period to be from the diagnosis to year 4 and\nwemakea2-yeartimeunitforeachstage,makingtwostages,stage1beingfromdiagnosistoyear2andstage2being\nfrom year 2 to year 4. We use D with subscript value s=1,2 to denote the decisions of the two stages, and j=1,2 to\ndenotethebiopsyandtreatmentactionswithinthestage.Thus,ifthesubjecthadabiopsyatthefirststage,wedenote\nD =1,otherwise,D =0.Forthosewithbiopsy,thatis,D =1,thetreatmentchoiceisrecordedasD ,1fortreated\n11 11 11 12\nand 0 for no treatment, and similarly for D and D . We note that once the patient is treated, no further biopsy or\n21 22\ntreatment will be observed. After the data preprocessing, 863 patients are kept in the dataset for the analysis, and of\nthese230didreceivecurativetreatment.Moreinformationregardingdatapreprocessingcanbefoundinsupplementary\nmaterials.\nAlthoughpatients,inreality,aresubjecttodifferentcategoriesoftreatments,suchasprostatectomy,radiationtherapy\norhormonetherapy,inthisanalysis,wecombinealldifferentkindsoftreatmentsintoonecategory(treated)topreserve\nasufficientsamplesizeforthetreatedsubjects.Otherpatientcharacteristics,includingage,race,baselinebiopsyresults,\nandbaselinePSAwerecollectedattheenrollment.Astheactivesurveillanceproceeded,thecorrespondingPSAchanges\nandthefollow-upbiopsyresultswerealsocollected.Inparticular,thequantityofcancer,asmeasuredbybiopsyresults,\nisbasedonboththenumberofneedlecorescontainingcancerandthecharacteristicofthecancertissuefoundwithin\neachsinglecore(Gleasonscore).Howtheindividualizeddatawasformattedtomatchthe2-yeartimeintervalforeach\nstageisdescribedinthesupplementarymaterials.Therewardoutcomeofinterestwaschosentoreflectlong-termdisease\nstatus,andisdefinedastheproportionofPSAvalueswhicharelessthan5outofallthePSAobservationscollectedfrom\ntheendofyear4afterdiagnosistotheendofstudy.Thisrewardrangesfrom0to1,withthelowervaluesimplyingmore\nundesirableriskofprostatecancerprogression.ThisrewardoutcomeonlyconsidersthediseaseprognosisbasedonPSA,\nandignoresthesideeffectsbroughtbyfrequentbiopsyandunnecessaryintervention.24Inparticular,thepainfulbiopsy\nprocedurecarriesnonnegligibleshort-andlong-termriskforpatients,whilethenontrivialprobabilityofafalsenegative\nbiopsyalsoposeschallengestothemedicalcommunitythatadvocatesforit.25Thus,afterconsultingwithsubjectmatter\nexperts,weincludepenaltiestodiscountthepatient\u2019srewardandthustotakeintoaccountpossiblesideeffects.MoreTANGetal. 6175\nFIGURE 2 TheestimatedoptimalDTRforJHUprostatecanceractivesurveillancedataviaSAT-Learningmethod.Thetreesshowhow\ntoprovideoptimalregimeateverystepbasedontheindividualizedcharacteristicsfor,A,stageonebiopsydecision,B,stageonetreatment\ndecisionifbiopsywastakeninstageone,C,stagetwobiopsydecision,andD,stagetwotreatmentdecisionifthebiopsywastakeninstagetwo\nspecifically,ifthepatienthadabiopsyineitheroneofthetwostages,theirrewardisreducedbyafactorof87%compared\nwiththeoriginalreward.Forapatientwhohaseverhadtreatment,therewardisreducedbyafactorof80%compared\nwiththeiroriginalreward.\nToapplytheproposedSAT-Learningalgorithmtotheactivesurveillancedatadescribedabove,weuserandomforests\nfortheconditionalmeanmodelandalogisticregressionmodelforthepropensityscoremodelofeverystepwithineach\nstage.TheestimatedoptimaltestandtreatmentDTRofthetwostagesareshowninFigure2.Accordingtotheestimated\noptimal DTR, at the first stage, men older than 56 are recommended for a biopsy test. Among those who are younger\nthan 56 years old, the patients with most recent PSA higher than 3.6 are also recommended for a biopsy test. Among\nthosedoingthebiopsytest,patientswiththemostrecentPSAhigherthan3.1andhavingbiopsytestshowinganycancer\narerecommendedforthetreatment.Atthesecondstage,themenwhosePSAchangefrombeginningofyear2islarger\nthan 1.3 are recommended for the biopsy test. For those who take the biopsy, if their most recent PSA is higher than\n3.2orthebiopsyresulthasmorethanonebiopsycoreneedleshowingcancerpositive,werecommendedthephysician\ntoofferthemthetreatment.Thestandardpracticeindecidingoncurativetreatmentdependsprimarilyonwhetherthe\nGleasongradeonthebiopsyisgreaterthanorequalto7.Incontrast,theDTRweestimatedinvolvesmorevariablesand\nchangesfromonestagetothenext,soismoreindividualized.ItisalsonotablethattheGleasonthresholdsintheabove\nDTRarelowerthaninstandardpractice,whichisconsistentwithasuggestionintheliterature.26 Therewardweuse,\nlongrunlowPSAvalues,certainlydoesinfluencetheestimatedoptimalDTR,whichinvolveslotsofdecisionsbasedon\nthecurrentPSAvalues.Theestimatedtree-basedDTRpresentedinFigure2isalsosensitivetothediscountfactor87%\nand 80% which are used to penalize the reward. Other rewards would have given different optimal DTRs. The reward\nwe useoflong-runPSAvalues canbeconsideredasaproxyforclinicalmeaningful\u201cgood\u201doutcome.Anidealreward\nwould involve long-term good quality of life and absence of prostate cancer recurrence. But data to construct such a\nreward is not available for this study. A sensitivity analysis with a modified reward is presented in the supplementary\nmaterials.Itispossibletoestimatewhattheimprovementintherewardwouldhavebeenifthepatientsfromourstudy\ncohort had followed the optimal DTR. We calculate that if our study cohort had received the optimal DTR described\nabove,thenmorethan86%ofthestudycohortwouldhaveseenanincreaseintheirreward.Thiswasespeciallythecase\namongthepatientswhohadnobiopsyexperienceinthestudy,byassigningthemtheoptimalregimes,almosteveryone\nwillincreasetherewardaccordingtoourestimates.Wealsocalculatethattheexpectednumberofpatientswhowould\nhavereceivedcurativetreatmentiftheyhadfollowedtheestimatedoptimalDTRis412,whichislargerthantheactual\nnumber of 230, but this number is sensitive to the factor that is used to discount the reward when a patient receives\ntreatment.6176 TANGetal.\n7 DISCUSSION\nMotivatedbytheembeddednatureofthediagnosisandtreatmentprocedures,wehavedevelopedanestedDTRframe-\nwork,withthetreatmentdecisionnestedwithinthetestdecisioninamultistagesetting,andimplementedtheestimation\noftheoptimalnestedDTRusingastep-adjustedtree-basedreinforcementlearningmethod(SAT-Learning).Thisnested\nDTRframeworkconsidersthetestdecisionandthenestedtreatmentdecisioninthesamestageanddevelopstheoptimal\nnestedDTRstomaximizetheexpectedlong-termrewards,suchasdiseasecontrol.Thiskindoftest-and-treatstrategy\nhasbeenconsideredpreviouslyinthehealthpolicyliterature.27Thesemethodsdiscussedtheimportanceoftheproblem,\nandtheneedtoaccumulatedata.Theyalsosuggestedsolutionsthatfocusedonthepopulationlevel,butnotinarigorous\nmathematicalframework.OurproposedmethodfollowstheframeworkofDTR,whichenablesphysicianstorepeatedly\ntailortestandtreatmentdecisionsbasedoneachindividual\u2019stime-varyinghealthhistories,andthusprovidesaneffective\ntoolforthepersonalizedmanagementofdiseaseovertime.\nSAT-Learning, our proposed method to solve the nested step-adjusted DTR problem, can potentially be imple-\nmented via modifying other learning methods that have been considered in DTR literature. However, by using a\nmodified T-RL algorithm,17 SAT-Learning is more straightforward to implement, understand and interpret, and capa-\nble of handling various data without distributional assumptions. Additionally, the doubly robust AIPW estimator that\nwe utilize in the purity measure in the tree structure also helps improve the robustness of our method against model\nmis-specifications.\nSeveraldevelopmentsandextensionscanbeexploredinfuturestudies.Onepossibleexplorationliesondealingwith\npotentiallycontradictorymultipleoutcomes.InSAT-Learning,weconsideranestedstep-adjustedDTRtoreducethepain\nand potential infections from frequent biopsy tests, but maintain an effective and in-time treatment to control disease\nprogression.Ifefficacyistheonlypurpose,onewouldexpectmorefrequenttestsandmoreaggressivetreatmentregardless\nofpossiblesideeffect,butinthemeantime,patientsmightexperiencemoresideeffects.Thedesireforefficacyandthe\ndesireforlesssideeffectsinfactcontradicteachother.Inclinicalpractice,physiciansareofteninterestedinbalancing\nmultiplecompetingclinicaloutcomes,suchasoverallsurvival,patientpreference,qualityoflife,andfinancialburden.28\nInordertobalancethesemultiplepotentiallycontradictoryobjectives,weappliedadifferentdiscountfactortothepatient\nrewardsfordifferentsideeffectsintheapplicationtotheJHUProstateCancerActiveSurveillancedata.Otherstatistical\nmethods have been developed to trade-off between multiple contradictory outcomes.8,29 One can further incorporate\nthesemultipleobjectiveoptimizationfunctionsintoourframeworkofnestedDTRforfutureresearch.Anotherpossible\nexplorationmaybeconsideringallavailableactionswhenthepreferenceofmultipleoutcomesvaries,30whichwouldgive\nmorecomprehensiveinformationabouthowtheoptimalityofanactionwouldbechangedifthepreferenceismodified.\nSensitivityanalysescanbedoneontheoptimalregimesandwouldprovidefurtherguidanceforthedecisionmakeron\ndevelopingamoreflexibleregimeamongalltheavailableinterventionstrategychoices.\nACKNOWLEDGEMENTS\nThe authors are grateful to Dr Brian Denton for providing the prostate cancer dataset. This research was partially\nsupportedbyNationalInstitutesofHealthgrantCA199338andCA129102.\nDATA AVAILABILITY STATEMENT\nThedatathatsupportthefindingsofthisstudyareavailablefromtheJohnsHopkinsUniversity.Restrictionsapplyto\ntheavailabilityofthesedata,whichwereusedunderlicenseforthisstudy.Dataareavailablefortheauthorswiththe\npermissionoftheJohnsHopkinsUniversity.\nORCID\nMingTang https://orcid.org/0000-0002-6451-8648\nREFERENCES\n1. ChakrabortyB,MurphySA.Dynamictreatmentregimes.AnnuRevStatAppl.2014;1(1):447-464.\n2. MurphySA.Optimaldynamictreatmentregimes.JRoyalStatSocSerB(StatMethodol).2003;65(2):331-355.\n3. WangL,RotnitzkyA,LinX,MillikanRE,ThallPF.Evaluationofviabledynamictreatmentregimesinasequentiallyrandomizedtrialof\nadvancedprostatecancer.JAmStatAssoc.2012;107(498):493-508.\n4. LoebS,BjurlinMA,NicholsonJ,etal.Overdiagnosisandovertreatmentofprostatecancer.EurUrol.2014;65(6):1046-1055.\n5. Itzkowitz S, Brand R, Jandorf L, et al. A simplified, noninvasive stool DNA test for colorectal cancer detection. Am J Gastroenterol.\n2008;103(11):2862.TANGetal. 6177\n6. USPreventiveServicesTaskForce.Screeningforbreastcancer:U.S.preventiveservicestaskforcerecommendationstatement.AnnInternal\nMed.2009;151(10):716.\n7. ChakrabortyB,LaberEB,ZhaoY.Inferenceforoptimaldynamictreatmentregimesusinganadaptivem-out-of-nbootstrapscheme.\nBiometrics.2013;69(3):714-723.\n8. LaberEB,LizotteDJ,FergusonB.Set-valueddynamictreatmentregimesforcompetingoutcomes.Biometrics.2014;70(1):53-61.\n9. ShiC,FanA,SongR,LuW.High-dimensionalA-learningforoptimaldynamictreatmentregimes.AnnStat.2018;46(3):925.\n10. EckermannS,WillanAR.ExpectedvalueofinformationanddecisionmakinginHTA.HealthEcon.2007;16(2):195-209.\n11. Zonta D, Glisic B, Adriaenssens S. Value of information: impact of monitoring on decision-making. Struct Control Health Monit.\n2014;21(7):1043-1056.\n12. RobinsJM,HernanMA,BrumbackB.Marginalstructuralmodelsandcausalinferenceinepidemiology.Epidemiology.2000;11:550-560.\n13. MurphySA,vanderLaanMJ,RobinsJM,ConductProblemsPreventionResearchGroup.Marginalmeanmodelsfordynamicregimes.\nJAmStatAssoc.2001;96(456):1410-1423.\n14. ThallPF,WootenLH,LogothetisCJ,MillikanRE,TannirNM.Bayesianandfrequentisttwo-stagetreatmentstrategiesbasedonsequential\nfailuretimessubjecttointervalcensoring.StatMed.2007;26(26):4687-4702.\n15. ZhaoYQ,ZengD,LaberEB,KosorokMR.Newstatisticallearningmethodsforestimatingoptimaldynamictreatmentregimes.JAmStat\nAssoc.2015;110(510):583-598.\n16. WatkinsCJCH,DayanP.Q-learning.MachLearn.1992;8(3-4):279-292.\n17. Tao Y, Wang L, Almirall D. Tree-based reinforcement learning for estimating optimal dynamic treatment regimes. Ann Appl Stat.\n2018;12(3):1914-1938.\n18. TaoY,WangL.Adaptivecontrastweightedlearningformulti-stagemulti-treatmentdecision-making.Biometrics.2017;73(1):145-155.\n19. ShenJ,WangL,TaylorJMG.Estimationoftheoptimalregimeintreatmentofprostatecancerrecurrencefromobservationaldatausing\nflexibleweightingmodels.Biometrics.2017;73(2):635-645.\n20. Huang X, Choi S, Wang L, Thall PF. Optimization of multi-stage dynamic treatment regimes utilizing accumulated data. Stat Med.\n2015;34(26):3424-3443.\n21. BreimanL,FriedmanJ,OlshenR,StoneC.ClassificationandRegressionTrees.Belmont,CA:Wadsworth;1984.\n22. TosoianJJ,TrockBJ,LandisP,etal.Activesurveillanceprogramforprostatecancer:anupdateoftheJohnsHopkinsexperience.JClin\nOncol.2011;29(16):2185-2190.\n23. DentonBT,HawleyST,MorganTM.Optimizingprostatecancersurveillance:usingdata-drivenmodelsforinformeddecision-making.\nEurUrol.2019;75(6):918.\n24. PezaroC,WooHH,DavisID.Prostatecancer:measuringPSA.InternMedJ.2014;44(5):433-440.\n25. ZhangJ,DentonBT,BalasubramanianH,ShahND,InmanBA.Optimizationofprostatebiopsyreferraldecisions.ManufServOperat\nManag.2012;14(4):529-547.\n26. Moyer VA. Screening for prostate cancer: U.S. preventive services task force recommendation statement. Ann Internal Med.\n2012;157(2):120.\n27. TrikalinosTA,SiebertU,LauJ.Decision-analyticmodelingtoevaluatebenefitsandharmsofmedicaltests:usesandlimitations.Med\nDecisMak.2009;29(5):E22-E29.\n28. ButlerEL.UsingPatientPreferencestoEstimateOptimalTreatmentStrategiesforCompetingOutcomesPhDthesis.TheUniversityofNorth\nCarolinaatChapelHill;2016.\n29. LizotteDJ,LaberEB.Multi-objectiveMarkovdecisionprocessesfordata-drivendecisionsupport.JMachLearnRes.2016;17:1-28.\n30. LizotteDJ,BowlingM,MurphySA.Linearfitted-Qiterationwithmultiplerewardfunctions.JMachLearnRes.2012;13:3253-3295.\nSUPPORTING INFORMATION\nAdditionalsupportinginformationmaybefoundonlineintheSupportingInformationsectionattheendofthisarticle.\nHowtocitethisarticle: TangM, WangL, GorinMA, TaylorJMG.Step-adjustedtree-basedreinforcement\nlearningforevaluatingnesteddynamictreatmentregimesusingtest-and-treatobservationaldata.Statisticsin\nMedicine.2021;40(27):6164-6177.https://doi.org/10.1002/sim.9177"
}